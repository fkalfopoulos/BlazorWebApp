@page "/customers"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@using EpsilonWebApp.Contracts.Models
@using EpsilonWebApp.Contracts.DTOs
@using EpsilonWebApp.Services.CustomerService
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Web
@using System.Net
@attribute [Authorize]
@inject ICustomerService CustomerService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider

<PageTitle>Customers</PageTitle>

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5">
                <i class="bi bi-people-fill text-primary"></i> Customers
            </h1>
            <p class="text-muted">Manage your customer database</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary btn-lg shadow-sm" @onclick="CreateCustomer" disabled="@isLoading">
                <i class="bi bi-plus-circle"></i> Create New Customer
            </button>
        </div>
    </div>

    @if (successMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill"></i> @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    @if (showUnauthorizedError)
    {
        <div class="card shadow-sm border-warning">
            <div class="card-body text-center py-5">
                <i class="bi bi-shield-lock display-1 text-warning mb-3"></i>
                <h3 class="text-warning">Session Expired</h3>
                <p class="text-muted mb-4">Your session has expired. Please log in again to continue.</p>
                <a href="/login" class="btn btn-primary btn-lg">
                    <i class="bi bi-box-arrow-in-right"></i> Go to Login
                </a>
            </div>
        </div>
    }
    else if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading customers...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }
    else if (customers != null)
    {
        @if (customers.TotalCount == 0)
        {
            <div class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h3 class="mt-3">No Customers Found</h3>
                    <p class="text-muted">Get started by creating your first customer</p>
                    <button class="btn btn-primary" @onclick="CreateCustomer">
                        <i class="bi bi-plus-circle"></i> Create First Customer
                    </button>
                </div>
            </div>
        }
        else
        {
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="px-4">Company Name</th>
                                    <th>Contact Name</th>
                                    <th>City</th>
                                    <th>Country</th>
                                    <th>Phone</th>
                                    <th class="text-center" style="width: 200px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var customer in customers.Items)
                                {
                                    <tr>
                                        <td class="px-4 fw-semibold">
                                            <i class="bi bi-building text-primary"></i>
                                            @customer.CompanyName
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(customer.ContactName))
                                            {
                                                <i class="bi bi-person"></i>
                                                <span>@customer.ContactName</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(customer.City))
                                            {
                                                <i class="bi bi-geo-alt"></i>
                                                <span>@customer.City</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>@(customer.Country ?? "-")</td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(customer.Phone))
                                            {
                                                <i class="bi bi-telephone"></i>
                                                <span>@customer.Phone</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary" 
                                                        @onclick="() => EditCustomer(customer.Id)"
                                                        title="Edit Customer">
                                                    <i class="bi bi-pencil"></i> Edit
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        @onclick="() => DeleteCustomer(customer.Id)"
                                                        title="Delete Customer">
                                                    <i class="bi bi-trash"></i> Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <nav aria-label="Customer pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">
                            <i class="bi bi-chevron-left"></i> Previous
                        </button>
                    </li>

                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(customers.TotalPages, currentPage + 2); i++)
                    {
                        var pageNumber = i;
                        <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                            <button class="page-link" @onclick="() => ChangePage(pageNumber)">@pageNumber</button>
                        </li>
                    }

                    <li class="page-item @(currentPage == customers.TotalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">
                            Next <i class="bi bi-chevron-right"></i>
                        </button>
                    </li>
                </ul>
            </nav>

            <div class="text-center text-muted mt-3">
                <small>
                    <i class="bi bi-info-circle"></i>
                    Showing @customers.Items.Count of @customers.TotalCount customers 
                    (Page @currentPage of @customers.TotalPages)
                </small>
            </div>
        }
    }
</div>

@code {
    private PagedResult<CustomerDto>? customers;
    private int currentPage = 1;
    private int pageSize = 10;
    private bool isLoading = true;
    private string? errorMessage;
    private string? successMessage;
    private bool showUnauthorizedError = false;

    protected override async Task OnInitializedAsync()
    {
        // Check authentication state first
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            // User is not authenticated - redirect to login
            Navigation.NavigateTo("/login", true);
            return;
        }

        await LoadCustomers();
    }

    private async Task LoadCustomers()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            showUnauthorizedError = false;
            customers = await CustomerService.GetCustomersAsync(currentPage, pageSize);
        }
        catch (HttpRequestException ex) when (ex.StatusCode == HttpStatusCode.Unauthorized || ex.Message.Contains("401"))
        {
            // Session expired or not authenticated - show friendly message
            showUnauthorizedError = true;
            isLoading = false;
        }
        catch (Exception ex)
        {
            // Check if it's an authentication/authorization error
            if (ex.Message.Contains("401") || ex.Message.Contains("Unauthorized"))
            {
                showUnauthorizedError = true;
            }
            else
            {
                errorMessage = "Unable to load customers. Please try again later.";
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ChangePage(int page)
    {
        if (page < 1 || (customers != null && page > customers.TotalPages))
            return;

        currentPage = page;
        await LoadCustomers();
    }

    private void CreateCustomer()
    {
        Navigation.NavigateTo("/customers/new");
    }

    private void EditCustomer(Guid id)
    {
        Navigation.NavigateTo($"/customers/edit/{id}");
    }

    private async Task DeleteCustomer(Guid id)
    {
        var customer = customers?.Items.FirstOrDefault(c => c.Id == id);
        var confirmMessage = customer != null 
            ? $"Are you sure you want to delete '{customer.CompanyName}'?" 
            : "Are you sure you want to delete this customer?";

        if (await JSRuntime.InvokeAsync<bool>("confirm", confirmMessage))
        {
            try
            {
                await CustomerService.DeleteCustomerAsync(id);
                successMessage = "Customer deleted successfully!";
                
                // Reload the current page
                await LoadCustomers();
                
                // Clear success message after 3 seconds
                _ = Task.Delay(3000).ContinueWith(_ => successMessage = null);
            }
            catch (HttpRequestException ex) when (ex.StatusCode == HttpStatusCode.Unauthorized || ex.Message.Contains("401"))
            {
                showUnauthorizedError = true;
            }
            catch (Exception ex)
            {
                if (ex.Message.Contains("401") || ex.Message.Contains("Unauthorized"))
                {
                    showUnauthorizedError = true;
                }
                else
                {
                    errorMessage = $"Failed to delete customer: {ex.Message}";
                }
            }
        }
    }
}
